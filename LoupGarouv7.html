<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loup-Garou de Thiercelieu - Simulateur Proc√©dural v5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 2px solid #ff6b6b;
        }
        
        .header h1 {
            color: #ff6b6b;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .header p {
            color: #a8dadc;
            font-size: 1.1em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .panel h2 {
            color: #a8dadc;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 10px;
        }
        
        .panel h3 {
            color: #ffb703;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #a8dadc;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ff6b6b;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e0e0;
            font-size: 0.9em;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="file"]:focus,
        select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: #a8dadc;
            box-shadow: 0 0 10px rgba(168, 218, 220, 0.3);
        }
        
        button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #457b9d 0%, #1d3557 100%);
        }
        
        button.secondary:hover {
            box-shadow: 0 5px 15px rgba(70, 123, 157, 0.4);
        }
        
        button.success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }
        
        .player-list {
            list-style: none;
        }
        
        .player-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-item.dead {
            opacity: 0.5;
            border-color: #ff6b6b;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #a8dadc;
        }
        
        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .role-unknown {
            background: #666;
            color: #ccc;
        }
        
        .role-villageois { background: #4caf50; }
        .role-loup { background: #ff6b6b; }
        .role-loupgarou { background: #ff6b6b; }
        .role-voyante { background: #9c27b0; }
        .role-sorciere { background: #e91e63; }
        .role-chasseur { background: #795548; }
        .role-cupidon { background: #ff4081; }
        .role-garde { background: #2196f3; }
        .role-petitefille { background: #ffeb3b; color: #000; }
        .role-maire { background: #ffa726; }
        .role-doberman { background: #8d6e63; }
        .role-influenceur { background: #ba68c8; }
        
        .game-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid #a8dadc;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }
        
        .log-entry.night {
            border-left-color: #1d3557;
        }
        
        .log-entry.day {
            border-left-color: #ffb703;
        }
        
        .log-entry.death {
            border-left-color: #ff6b6b;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #a8dadc;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #8b8b8b;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .phase-indicator {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .phase-indicator h3 {
            color: #ffb703;
            font-size: 1.5em;
        }
        
        .end-screen {
            text-align: center;
            padding: 40px;
        }
        
        .end-screen h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }
        
        .winner-team {
            font-size: 2em;
            color: #4caf50;
            margin-bottom: 30px;
        }
        
        .hide {
            display: none;
        }
        
        .role-count {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .role-count input {
            width: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê∫ Loup-Garou de Thiercelieu v5 üê∫</h1>
            <p>Simulateur Proc√©dural Avanc√© - Version Ultime</p>
        </div>

        <!-- √âCRAN DE CONFIGURATION -->
        <div id="setupScreen">
            <div class="main-content">
                <div class="panel">
                    <h2>‚öôÔ∏è Configuration</h2>
                    
                    <div class="form-group">
                        <label>Nombre de Joueurs:</label>
                        <input type="number" id="playerCount" value="8" min="4" max="20">
                    </div>
                    
                    <div class="form-group">
                        <label>Nom du Joueur:</label>
                        <input type="text" id="playerName" placeholder="Ex: Marie">
                    </div>
                    
                    <div class="form-group">
                        <label>Personnalit√©:</label>
                        <select id="playerPersonality">
                            <option value="courageux">Courageux</option>
                            <option value="m√©fiant">M√©fiant</option>
                            <option value="bavard">Bavard</option>
                            <option value="calme">Calme</option>
                            <option value="nerveux">Nerveux</option>
                            <option value="malin">Malin</option>
                            <option value="honn√™te">Honn√™te</option>
                            <option value="sournois">Sournois</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Image du joueur:</label>
                        <input type="file" id="playerImage" accept="image/*">
                    </div>
                    
                    <button onclick="addPlayer()">+ Ajouter</button>
                    <button class="secondary" onclick="generateRandomPlayers()">üé≤ G√©n√©rer Al√©atoire</button>
                    
                    <h3>Joueurs Ajout√©s:</h3>
                    <ul class="player-list" id="playerListSetup"></ul>
                    
                    <h3>üìö Joueurs Sauvegard√©s:</h3>
                    <ul class="player-list" id="savedPlayersList"></ul>
                </div>
                
                <div class="panel">
                    <h2>üé≤ R√¥les et Param√®tres</h2>
                    
                    <h3>Nombre de R√¥les par Partie:</h3>
                    <div id="roleCountsContainer"></div>
                    
                    <h3>Param√®tres:</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="hidePreciseTargets" checked>
                            Cacher les cibles pr√©cises (pas de spoil)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="hideGuardProtection" checked>
                            Cacher qui est prot√©g√© par le Garde
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="revealRolesAtEnd" checked>
                            R√©v√©ler les r√¥les √† la fin
                        </label>
                    </div>
                    
                    <button class="success" onclick="startGame()" style="margin-top: 20px; padding: 12px 24px; font-size: 1.1em;">üéÆ D√©marrer la Partie</button>
                </div>
            </div>
        </div>

        <!-- √âCRAN DE JEU -->
        <div id="gameScreen" class="hide">
            <div class="main-content">
                <div class="panel">
                    <h2>üìä Statut</h2>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="villageoisCount">0</div>
                            <div class="stat-label">Villageois</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="loupsCount">0</div>
                            <div class="stat-label">Loups</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="aliveCount">0</div>
                            <div class="stat-label">En vie</div>
                        </div>
                    </div>
                    
                    <button class="secondary" onclick="backToSetup()" style="margin-top: 20px;">‚Ü©Ô∏è Retour Setup</button>
                    
                    <h3 style="margin-top: 20px;">√âtat des Personnages:</h3>
                    <ul class="player-list" id="playerListGame"></ul>
                </div>
                
                <div class="panel">
                    <div class="phase-indicator">
                        <h3 id="phaseTitle">Jour 1</h3>
                        <p id="phaseSubtitle">Phase de Nuit</p>
                    </div>
                    
                    <div class="game-log" id="gameLog"></div>
                    
                    <div class="navigation">
                        <button onclick="previousPhase()">‚¨ÖÔ∏è Pr√©c√©dent</button>
                        <button onclick="nextPhase()">Suivant ‚û°Ô∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- √âCRAN DE FIN -->
        <div id="endScreen" class="hide">
            <div class="end-screen">
                <h2>üéâ Fin de la Partie! üéâ</h2>
                <div class="winner-team" id="winnerTeam"></div>
                <button class="success" onclick="newGame()">üîÑ Nouvelle Partie</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DICTIONNAIRE DE PR√âNOMS F√âMININS =====
        const femaleNames = [
            "marie", "sophie", "camille", "julie", "emma", "l√©a", "manon", "chlo√©", "laura", "sarah",
            "lucie", "oc√©ane", "morgane", "ana√Øs", "pauline", "marine", "claire", "alice", "√©lise", "valentine",
            "charlotte", "am√©lie", "juliette", "louise", "zo√©", "lisa", "margaux", "mathilde", "justine", "√©lodie",
            "c√©line", "aur√©lie", "nathalie", "isabelle", "catherine", "val√©rie", "martine", "fran√ßoise", "sylvie", "v√©ronique",
            "florence", "st√©phanie", "sandrine", "corinne", "monique", "brigitte", "nicole", "dominique", "h√©l√®ne", "agn√®s"
        ];

        // Fonction pour d√©terminer le genre d'un pr√©nom
        function getGender(name) {
            return femaleNames.includes(name.toLowerCase().trim()) ? "f√©minin" : "masculin";
        }

        // Fonction pour accorder les mots selon le genre
        function accord(text, gender) {
            if (gender === "f√©minin") {
                // R√®gles d'accord au f√©minin
                if (text === "tu√©") return "tu√©e";
                if (text === "√©limin√©") return "√©limin√©e";
                if (text === "d√©vor√©") return "d√©vor√©e";
                if (text === "empoisonn√©") return "empoisonn√©e";
                if (text === "mort") return "morte";
                if (text === "prot√©g√©") return "prot√©g√©e";
                if (text === "Il") return "Elle";
                if (text === "il") return "elle";
                if (text === "son") return "sa";
                if (text === "un") return "une";
                // Pour les autres cas, ajouter un 'e' si pas d√©j√† pr√©sent
                if (!text.endsWith("e")) return text + "e";
            }
            return text;
        }

        // ===== DONN√âES DU JEU =====
        let players = [];
        let savedPlayers = [];
        let gameHistory = [];
        let currentPhaseIndex = 0;
        let gameState = {
            day: 1,
            phase: "night",
            roles: {},
            dead: [],
            couples: [],
            witchPotions: {},
            seerDiscoveries: {},
            playerAccusations: {},
            revealedRoles: {} // Nouveaux r√¥les r√©v√©l√©s √† chaque phase
        };

        const roles = [
            { name: "Villageois", icon: "üë®‚Äçüåæ", defaultCount: 0 },
            { name: "Loup-Garou", icon: "üê∫", defaultCount: 2 },
            { name: "Voyante", icon: "üîÆ", defaultCount: 1 },
            { name: "Sorci√®re", icon: "üß™", defaultCount: 1 },
            { name: "Chasseur", icon: "üèπ", defaultCount: 1 },
            { name: "Cupidon", icon: "üíò", defaultCount: 1 },
            { name: "Garde", icon: "üõ°Ô∏è", defaultCount: 1 },
            { name: "Petite Fille", icon: "üëß", defaultCount: 1 },
            { name: "Maire", icon: "üëî", defaultCount: 1 },
            { name: "Doberman", icon: "üêï", defaultCount: 1 },
            { name: "Influenceur", icon: "üì±", defaultCount: 1 }
        ];

        // Pr√©noms fran√ßais courants
        const commonNames = [
            // === PR√âNOMS MASCULINS ===
            // Tr√®s populaires ann√©es 2020
            "L√©o", "Gabriel", "Rapha√´l", "Noah", "Louis", "Adam", "Arthur", "Ma√´l", "Milo", "Jules",
            "Eden", "Aaron", "Ethan", "Nathan", "Enzo", "Tom", "Hugo", "Tim√©o", "Sacha", "Elio",
            "Na√´l", "Liam", "Nolan", "Ayden", "Ibrahim", "Mohamed", "Amine", "Youssef", "Ilyes", "Rayan",

            // Populaires ann√©es 2010
            "Lucas", "Maxime", "Thomas", "Theo", "Paul", "Victor", "Cl√©ment", "Antoine", "Baptiste", "Alexandre",
            "Mathis", "Robin", "Axel", "Matteo", "Math√©o", "Simon", "L√©on", "Evan", "Gabin",

            // Ann√©es 2000-2010
            "Nicolas", "Julien", "Maxence", "Valentin", "Quentin", "Florian", "Alexis", "Romain", "Dylan",
            "Kevin", "Anthony", "Jordan", "Adrien", "Benjamin", "Damien", "Pierre", "Vincent", "Guillaume", "Mathieu",

            // Pr√©noms diversifi√©s populaires
            "Djibril", "Mamadou", "Moussa", "Zakary", "Yanis", "Mehdi", "Karim", "Malik", "Samy", "Ayoub",
            "Sofiane", "Zacharie", "Robinson", "Alyc", "Killian", "Lohan", "Nino", "Mael", "Loris", "Tanguy",

            // === PR√âNOMS F√âMININS ===
            // Tr√®s populaires ann√©es 2020
            "Emma", "Jade", "Louise", "Alice", "Rose", "Mia", "Julia", "Lina", "L√©a", "Chlo√©",
            "Ambre", "In√®s", "Anna", "Lou", "Romy", "Luna", "Iris", "Alba", "Agathe", "Olivia",

            // Tendance ann√©es 2010
            "Clara", "Eva", "Zo√©", "Sarah", "Camille", "Lola", "Manon", "Juliette", "Lisa", "Charlotte",
            "L√©na", "Ma√´lys", "Romane", "Nina", "Victoria", "Inaya", "Ma√´lle", "Nour", "Yasmine", "Maya",

            // Populaires ann√©es 2000
            "Laura", "Oc√©ane", "Marie", "Julie", "Lucie", "Margaux", "Mathilde", "Ad√®le", "Pauline", "Marine", "Ana√Øs",
            "Morgane", "Justine", "Margot", "Cl√©mence", "√âlise", "Valentine", "Am√©lie", "Elisa", "Jeanne", "No√©mie",

            // Ann√©es 1995-2005
            "M√©lissa", "M√©gane", "Coralie", "Maeva", "Charl√®ne", "Alexia", "√âmilie", "Oph√©lie", "Fanny", "Sol√®ne",
            "C√©lia", "Laurine", "Alicia", "Audrey", "Cassandra", "Cl√©mentine", "Axelle", "Estelle", "Marion", "Sophie",

            // Pr√©noms wtf
            "Mario", "Luigi", "Wario", "Naruto", "Waluigi", "Ichigo", "Saitama", "Bowser", "Jack", "Jul",
            "Kaaris", "Sonic", "Sasuke", "Ronald McDonald", "Emile", "Pikachu", "Goku", "Cyprien", "Squeezie",
            "Maitre Gims", "Toad", "Charlie Haid", "Herm√®s", "Virgil", "John", "Ali", "Marley", "Beethoven", "Dieu"
        ];

        const personalities = ["courageux", "m√©fiant", "bavard", "calme", "nerveux", "malin", "honn√™te", "sournois"];

        // ===== INITIALISATION =====
        function init() {
            loadSavedPlayers();
            renderRoleCounts();
            renderSavedPlayers();
        }

        function renderRoleCounts() {
            const container = document.getElementById("roleCountsContainer");
            container.innerHTML = "";
            
            roles.forEach(role => {
                const div = document.createElement("div");
                div.className = "role-count";
                div.innerHTML = `
                    <span>${role.icon} ${role.name}:</span>
                    <input type="number" id="role_${role.name}" value="${role.defaultCount}" min="0" max="10">
                `;
                container.appendChild(div);
            });
        }

        // ===== GESTION DES JOUEURS =====
        function addPlayer() {
            const name = document.getElementById("playerName").value.trim();
            const personality = document.getElementById("playerPersonality").value;
            const imageFile = document.getElementById("playerImage").files[0];
            
            if (!name) {
                alert("Veuillez entrer un nom de joueur.");
                return;
            }
            
            const gender = getGender(name);
            
            const player = {
                name: name,
                personality: personality,
                gender: gender,
                image: null
            };
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    player.image = e.target.result;
                    players.push(player);
                    renderPlayerList();
                };
                reader.readAsDataURL(imageFile);
            } else {
                players.push(player);
                renderPlayerList();
            }
            
            document.getElementById("playerName").value = "";
            document.getElementById("playerImage").value = "";
        }

        function removePlayer(index) {
            players.splice(index, 1);
            renderPlayerList();
        }

        function savePlayer(index) {
            savedPlayers.push({...players[index]});
            localStorage.setItem("savedPlayers", JSON.stringify(savedPlayers));
            renderSavedPlayers();
        }

        function loadSavedPlayer(index) {
            players.push({...savedPlayers[index]});
            renderPlayerList();
        }

        function deleteSavedPlayer(index) {
            savedPlayers.splice(index, 1);
            localStorage.setItem("savedPlayers", JSON.stringify(savedPlayers));
            renderSavedPlayers();
        }

        function loadSavedPlayers() {
            const saved = localStorage.getItem("savedPlayers");
            if (saved) {
                savedPlayers = JSON.parse(saved);
            }
        }

        function renderPlayerList() {
            const list = document.getElementById("playerListSetup");
            list.innerHTML = "";
            
            players.forEach((player, index) => {
                const li = document.createElement("li");
                li.className = "player-item";
                li.innerHTML = `
                    <div class="player-info">
                        ${player.image ? `<img src="${player.image}" class="player-image">` : `<div class="player-image" style="background: #666; display: flex; align-items: center; justify-content: center;">üë§</div>`}
                        <span>${player.name} (${player.personality})</span>
                    </div>
                    <div>
                        <button onclick="savePlayer(${index})">üíæ</button>
                        <button onclick="removePlayer(${index})">‚ùå</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function renderSavedPlayers() {
            const list = document.getElementById("savedPlayersList");
            list.innerHTML = "";
            
            savedPlayers.forEach((player, index) => {
                const li = document.createElement("li");
                li.className = "player-item";
                li.innerHTML = `
                    <div class="player-info">
                        ${player.image ? `<img src="${player.image}" class="player-image">` : `<div class="player-image" style="background: #666; display: flex; align-items: center; justify-content: center;">üë§</div>`}
                        <span>${player.name} (${player.personality})</span>
                    </div>
                    <div>
                        <button onclick="loadSavedPlayer(${index})">üì•</button>
                        <button onclick="deleteSavedPlayer(${index})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function generateRandomPlayers() {
            const count = parseInt(document.getElementById("playerCount").value);
            players = [];

            const usedNames = new Map();

            for (let i = 0; i < count; i++) {
                let baseName;

                if (i < commonNames.length) {
                    baseName = commonNames[i % commonNames.length];
                } else {
                    baseName = commonNames[i % commonNames.length];
                }

                let finalName = baseName;
                let counter = usedNames.get(baseName) || 0;

                if (counter > 0) {
                    finalName = baseName + counter;
                }

                usedNames.set(baseName, counter + 1);

                const personality = personalities[Math.floor(Math.random() * personalities.length)];
                const gender = getGender(finalName);

                players.push({
                    name: finalName,
                    personality: personality,
                    gender: gender,
                    image: null
                });
            }

            renderPlayerList();
        }

        
        function startGame() {
            const requiredPlayers = parseInt(document.getElementById("playerCount").value);

            // Compl√©ter avec des joueurs g√©n√©r√©s si n√©cessaire
            if (players.length < requiredPlayers) {
                const usedNames = new Set(players.map(p => p.name));
                const usedBaseNames = new Map();

                // Compter les noms d√©j√† utilis√©s
                players.forEach(p => {
                    const baseName = p.name.replace(/\d+$/, '');
                    usedBaseNames.set(baseName, (usedBaseNames.get(baseName) || 0) + 1);
                });

                let nameIndex = 0;
                while (players.length < requiredPlayers) {
                    let baseName;
                    let finalName;

                    if (nameIndex < commonNames.length) {
                        baseName = commonNames[nameIndex];
                        let counter = usedBaseNames.get(baseName) || 0;

                        if (counter > 0) {
                            finalName = baseName + counter;
                        } else {
                            finalName = baseName;
                        }

                        if (!usedNames.has(finalName)) {
                            usedBaseNames.set(baseName, counter + 1);
                            usedNames.add(finalName);
                        } else {
                            nameIndex++;
                            continue;
                        }
                    } else {
                        // Utiliser des placeholders si on a √©puis√© tous les pr√©noms
                        let placeholderNum = 1;
                        do {
                            finalName = "Joueur" + placeholderNum;
                            placeholderNum++;
                        } while (usedNames.has(finalName));
                        usedNames.add(finalName);
                    }

                    const personality = personalities[Math.floor(Math.random() * personalities.length)];
                    const gender = getGender(finalName);

                    players.push({
                        name: finalName,
                        personality: personality,
                        gender: gender,
                        image: null
                    });

                    nameIndex++;
                }

                renderPlayerList();
            }

            if (players.length < 4) {
                alert("Il faut au moins 4 joueurs pour commencer.");
                return;
            }

            gameState = {
                day: 1,
                phase: "night",
                roles: {},
                dead: [],
                couples: [],
                witchPotions: {},
                seerDiscoveries: {},
                playerAccusations: {},
                revealedRoles: {}
            };
            gameHistory = [];
            currentPhaseIndex = 0;

            assignRoles();

            players.forEach(player => {
                if (player.role === "Sorci√®re") {
                    gameState.witchPotions[player.name] = { heal: true, poison: true };
                }
                if (player.role === "Voyante") {
                    gameState.seerDiscoveries[player.name] = [];
                }
                gameState.playerAccusations[player.name] = [];
            });

            simulateCupidPhase();

            document.getElementById("setupScreen").classList.add("hide");
            document.getElementById("gameScreen").classList.remove("hide");
            document.getElementById("endScreen").classList.add("hide");

            updateGameDisplay();
        }

        function assignRoles() {
            const roleDistribution = [];
            
            roles.forEach(role => {
                const count = parseInt(document.getElementById(`role_${role.name}`).value) || 0;
                for (let i = 0; i < count; i++) {
                    roleDistribution.push(role.name);
                }
            });
            
            while (roleDistribution.length < players.length) {
                roleDistribution.push("Villageois");
            }
            
            roleDistribution.sort(() => Math.random() - 0.5);
            
            players.forEach((player, index) => {
                player.role = roleDistribution[index];
                player.originalRole = roleDistribution[index]; // Pour le Doberman
                player.alive = true;
                player.protected = false;
                player.inCouple = false;
                player.knownRole = null;
            });
        }

        function simulateCupidPhase() {
            const cupids = players.filter(p => p.role === "Cupidon" && p.alive);
            
            cupids.forEach(cupid => {
                const availablePlayers = players.filter(p => p.alive && !p.inCouple && p.name !== cupid.name);
                
                if (availablePlayers.length >= 2) {
                    const person1 = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];
                    const person2Index = Math.floor(Math.random() * (availablePlayers.length - 1));
                    const person2 = availablePlayers.filter(p => p.name !== person1.name)[person2Index];
                    
                    person1.inCouple = true;
                    person2.inCouple = true;
                    
                    gameState.couples.push({
                        cupid: cupid.name,
                        couple: [person1.name, person2.name]
                    });
                    
                    const hideTargets = document.getElementById("hidePreciseTargets").checked;
                    if (hideTargets) {
                        addLogEntry(`üíò Cupidon a form√© un couple secret.`, "night");
                    } else {
                        addLogEntry(`üíò Cupidon a form√© un couple entre ${person1.name} et ${person2.name}.`, "night");
                    }
                }
            });
        }

        // ===== SIMULATION DU JEU =====
        function nextPhase() {
            if (currentPhaseIndex < gameHistory.length - 1) {
                currentPhaseIndex++;
                updateGameDisplay();
                return;
            }
            
            if (gameState.phase === "night") {
                simulateNightPhase();
                gameState.phase = "day";
            } else {
                simulateDayPhase();
                gameState.day++;
                gameState.phase = "night";
            }
            
            currentPhaseIndex = gameHistory.length - 1;
            updateGameDisplay();
            
            checkGameEnd();
        }

        function previousPhase() {
            if (currentPhaseIndex > 0) {
                currentPhaseIndex--;
                updateGameDisplay();
            }
        }

        function simulateNightPhase() {
            addLogEntry(`üåô Nuit ${gameState.day}`, "night");
            addLogEntry("Le village s'endort. Les loups-garous se r√©veillent...", "night");
            
            players.forEach(p => p.protected = false);
            
            // Phase des Loups-Garous
            const wolves = players.filter(p => p.role === "Loup-Garou" && p.alive);
            if (wolves.length > 0) {
                const targets = players.filter(p => p.alive && p.role !== "Loup-Garou");
                if (targets.length > 0) {
                    const target = targets[Math.floor(Math.random() * targets.length)];
                    
                    const hideTargets = document.getElementById("hidePreciseTargets").checked;
                    if (hideTargets) {
                        addLogEntry(`üê∫ Les loups-garous ont choisi une victime...`, "night");
                    } else {
                        addLogEntry(`üê∫ Les loups-garous ont choisi ${target.name} comme victime.`, "night");
                    }
                    
                    // Garde
                    const guards = players.filter(p => p.role === "Garde" && p.alive);
                    const hideGuard = document.getElementById("hideGuardProtection").checked;
                    
                    guards.forEach(guard => {
                        const protectTargets = players.filter(p => p.alive);
                        if (protectTargets.length > 0) {
                            const protected = protectTargets[Math.floor(Math.random() * protectTargets.length)];
                            protected.protected = true;
                            
                            if (!hideGuard) {
                                addLogEntry(`üõ°Ô∏è Le Garde ${guard.name} prot√®ge ${protected.name}.`, "night");
                            } else {
                                addLogEntry(`üõ°Ô∏è Un Garde prot√®ge quelqu'un...`, "night");
                            }
                        }
                    });
                    
                    // Sorci√®re
                    const witches = players.filter(p => p.role === "Sorci√®re" && p.alive);
                    let targetSaved = false;
                    let poisonUsed = false;
                    
                    witches.forEach(witch => {
                        const potions = gameState.witchPotions[witch.name];
                        
                        if (target.name === witch.name && potions.heal && !target.protected) {
                            potions.heal = false;
                            targetSaved = true;
                            const hideTargets1 = document.getElementById("hidePreciseTargets").checked;
                            if (hideTargets1) {
                                addLogEntry(`üß™ La Sorci√®re utilise sa potion de vie.`, "night");
                            } else {
                                addLogEntry(`üß™ La Sorci√®re utilise sa potion de vie sur elle-m√™me!`, "night");
                            }
                        } else {
                            const usePotion = Math.random() < 0.33;
                            
                            if (usePotion) {
                                const availablePotions = [];
                                if (potions.heal) availablePotions.push("heal");
                                if (potions.poison) availablePotions.push("poison");
                                
                                if (availablePotions.length > 0) {
                                    const chosenPotion = availablePotions[Math.floor(Math.random() * availablePotions.length)];
                                    
                                    if (chosenPotion === "heal" && !target.protected) {
                                        potions.heal = false;
                                        targetSaved = true;
                                        const hideTargets2 = document.getElementById("hidePreciseTargets").checked;
                                        if (hideTargets2) {
                                            addLogEntry(`üß™ La Sorci√®re utilise sa potion de vie pour sauver quelqu'un.`, "night");
                                        } else {
                                            addLogEntry(`üß™ La Sorci√®re utilise sa potion de vie pour sauver ${target.name}.`, "night");
                                        }
                                    } else if (chosenPotion === "poison") {
                                        potions.poison = false;
                                        const poisonTargets = players.filter(p => p.alive && p.name !== witch.name);
                                        if (poisonTargets.length > 0) {
                                            const poisonVictim = poisonTargets[Math.floor(Math.random() * poisonTargets.length)];
                                            poisonUsed = true;
                                            const hideTargets3 = document.getElementById("hidePreciseTargets").checked;
                                            if (hideTargets3) {
                                                addLogEntry(`üß™ La Sorci√®re utilise sa potion de poison.`, "night");
                                            } else {
                                                addLogEntry(`üß™ La Sorci√®re utilise sa potion de poison sur ${poisonVictim.name}!`, "night");
                                            }
                                            killPlayer(poisonVictim.name, "poison");
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Voyante - R√âV√âLE LE R√îLE EXACT
                    const seers = players.filter(p => p.role === "Voyante" && p.alive);
                    seers.forEach(seer => {
                        const seerTargets = players.filter(p => p.alive && p.name !== seer.name);
                        if (seerTargets.length > 0) {
                            const investigated = seerTargets[Math.floor(Math.random() * seerTargets.length)];
                            
                            if (!gameState.seerDiscoveries[seer.name].includes(investigated.name)) {
                                gameState.seerDiscoveries[seer.name].push(investigated.name);
                                investigated.knownRole = investigated.role;
                                
                                // Ajouter aux r√¥les r√©v√©l√©s pour l'affichage
                                gameState.revealedRoles[investigated.name] = investigated.role;
                            }
                            
                            // R√©v√©ler le r√¥le exact
                            addLogEntry(`üîÆ La Voyante d√©couvre que ${investigated.name} est ${investigated.role}.`, "night");
                        }
                    });
                    
                    // R√©solution de l'attaque des loups
                    if (!target.protected && !targetSaved) {
                        // V√©rifier si c'est un Doberman
                        if (target.role === "Doberman") {
                            target.role = "Loup-Garou";
                            addLogEntry(`üêï ${target.name} √©tait ${accord("un", target.gender)} Doberman! ${accord("Il", target.gender)} devient ${accord("un", target.gender)} Loup-Garou!`, "night");
                        } else {
                            killPlayer(target.name, "wolf");
                        }
                    } else if (target.protected && !targetSaved) {
                        addLogEntry(`üõ°Ô∏è ${target.name} a √©t√© ${accord("prot√©g√©", target.gender)} par un Garde!`, "night");
                    }
                }
            }
        }

        function simulateDayPhase() {
            addLogEntry(`‚òÄÔ∏è Jour ${gameState.day}`, "day");
            addLogEntry("Le village se r√©veille...", "day");
            
            const alivePlayers = players.filter(p => p.alive);
            if (alivePlayers.length === 0) return;
            
            const speakerCount = Math.ceil(alivePlayers.length / 2);
            const speakers = [];
            const alivePlayersCopy = [...alivePlayers];
            
            for (let i = 0; i < speakerCount && alivePlayersCopy.length > 0; i++) {
                const speakerIndex = Math.floor(Math.random() * alivePlayersCopy.length);
                speakers.push(alivePlayersCopy[speakerIndex]);
                alivePlayersCopy.splice(speakerIndex, 1);
            }
            
            const accusations = {};
            
            speakers.forEach(speaker => {
                const possibleTargets = players.filter(p => p.alive && p.name !== speaker.name);
                if (possibleTargets.length > 0) {
                    let accused;

                    // V√©rifier si des loups-garous ont √©t√© r√©v√©l√©s par la Voyante
                    const revealedWolves = possibleTargets.filter(p => 
                        gameState.revealedRoles[p.name] === "Loup-Garou" && p.alive
                    );

                    // 60% de chance de cibler un loup r√©v√©l√© si disponible
                    if (revealedWolves.length > 0 && Math.random() < 0.6) {
                        accused = revealedWolves[Math.floor(Math.random() * revealedWolves.length)];
                        if (!gameState.playerAccusations[speaker.name].includes(accused.name)) {
                            gameState.playerAccusations[speaker.name].push(accused.name);
                        }
                    } else {
                        const previousAccusations = gameState.playerAccusations[speaker.name].filter(name => 
                            players.find(p => p.name === name && p.alive)
                        );

                        if (previousAccusations.length > 0 && Math.random() < 0.7) {
                            const previousTarget = previousAccusations[previousAccusations.length - 1];
                            accused = players.find(p => p.name === previousTarget);
                        } else {
                            accused = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
                            gameState.playerAccusations[speaker.name].push(accused.name);
                        }
                    }

                    // Calculer le poids de l'accusation selon le r√¥le
                    let weight = 1;
                    if (speaker.role === "Maire") weight = 2;
                    if (speaker.role === "Influenceur") weight = 3;
                    
                    accusations[accused.name] = (accusations[accused.name] || 0) + weight;
                    
                    const reasons = [
                        "comportement suspect",
                        "silence √©trange",
                        "nervosit√© excessive",
                        "contradictions dans ses propos",
                        "regard fuyant"
                    ];
                    const reason = reasons[Math.floor(Math.random() * reasons.length)];
                    
                    let roleInfo = "";
                    if (speaker.role === "Maire") roleInfo = " (Maire - vote x2)";
                    if (speaker.role === "Influenceur") roleInfo = " (Influenceur - vote x3)";
                    
                    addLogEntry(`üí¨ ${speaker.name}${roleInfo} accuse ${accused.name} pour ${reason}.`, "day");
                }
            });
            
            const eliminationCandidates = Object.entries(accusations).map(([name, weight]) => ({
                name,
                weight,
                chance: weight * 30
            }));
            
            alivePlayers.forEach(player => {
                if (!accusations[player.name]) {
                    eliminationCandidates.push({
                        name: player.name,
                        weight: 0,
                        chance: 5
                    });
                }
            });
            
            const totalChance = eliminationCandidates.reduce((sum, c) => sum + c.chance, 0);
            let random = Math.random() * totalChance;
            let eliminated = null;
            
            for (const candidate of eliminationCandidates) {
                random -= candidate.chance;
                if (random <= 0) {
                    eliminated = candidate.name;
                    break;
                }
            }
            
            if (eliminated) {
                const eliminatedPlayer = players.find(p => p.name === eliminated);
                addLogEntry(`‚öñÔ∏è Le village a vot√©. ${eliminated} est ${accord("√©limin√©", eliminatedPlayer.gender)}!`, "day");
                killPlayer(eliminated, "vote");
                
                const hunter = players.find(p => p.name === eliminated && p.role === "Chasseur");
                if (hunter) {
                    const targets = players.filter(p => p.alive);
                    if (targets.length > 0) {
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        addLogEntry(`üèπ ${hunter.name} √©tait ${accord("le", hunter.gender === "f√©minin" ? "la" : "le")} Chasseur! ${accord("Il", hunter.gender)} riposte et √©limine ${target.name}!`, "death");
                        killPlayer(target.name, "hunter");
                    }
                }
            } else {
                addLogEntry(`‚öñÔ∏è Le village n'a pas r√©ussi √† se mettre d'accord. Personne n'est √©limin√©.`, "day");
            }
        }

        function killPlayer(playerName, cause) {
            const player = players.find(p => p.name === playerName);
            if (!player || !player.alive) return;
            
            player.alive = false;
            gameState.dead.push(playerName);
            
            // R√©v√©ler le r√¥le du mort
            gameState.revealedRoles[playerName] = player.role;
            
            let causeText = "";
            switch (cause) {
                case "wolf": 
                    causeText = `${accord("d√©vor√©", player.gender)} par les loups-garous`; 
                    break;
                case "poison": 
                    causeText = `${accord("empoisonn√©", player.gender)}`; 
                    break;
                case "vote": 
                    causeText = `${accord("√©limin√©", player.gender)} par le village`; 
                    break;
                case "hunter": 
                    causeText = `${accord("tu√©", player.gender)} par le Chasseur`; 
                    break;
                case "love": 
                    causeText = `${accord("mort", player.gender)} de chagrin`; 
                    break;
            }
            
            if (cause !== "vote") {
                const roleIcon = roles.find(r => r.name === player.role)?.icon || "‚ùì";
                addLogEntry(`üíÄ ${player.name} (${roleIcon} ${player.role}) est ${causeText}.`, "death");
            } else {
                const roleIcon = roles.find(r => r.name === player.role)?.icon || "‚ùì";
                addLogEntry(`üíÄ ${player.name} √©tait ${roleIcon} ${player.role}.`, "death");
            }
            
            // V√©rifier si le joueur √©tait en couple
            gameState.couples.forEach(couple => {
                if (couple.couple.includes(playerName)) {
                    const partner = couple.couple.find(name => name !== playerName);
                    const partnerObj = players.find(p => p.name === partner);
                    
                    if (partnerObj && partnerObj.alive) {
                        addLogEntry(`üíî ${partner} meurt de chagrin car ${accord("son", partnerObj.gender)} ${partnerObj.gender === "f√©minin" ? "amoureuse" : "amoureux"} est ${player.gender === "f√©minin" ? "morte" : "mort"}.`, "death");
                        killPlayer(partner, "love");
                    }
                }
            });
        }

        function addLogEntry(text, type) {
            gameHistory.push({ text, type, day: gameState.day, phase: gameState.phase });
        }

        function updateGameDisplay() {
            const phase = gameHistory[currentPhaseIndex]?.phase || "night";
            const day = gameHistory[currentPhaseIndex]?.day || 1;
            
            document.getElementById("phaseTitle").textContent = `Jour ${day}`;
            document.getElementById("phaseSubtitle").textContent = phase === "night" ? "Phase de Nuit" : "Phase de Jour";
            
            const logContainer = document.getElementById("gameLog");
            logContainer.innerHTML = "";
            
            for (let i = 0; i <= currentPhaseIndex; i++) {
                const entry = gameHistory[i];
                const div = document.createElement("div");
                div.className = `log-entry ${entry.type}`;
                div.textContent = entry.text;
                logContainer.appendChild(div);
            }
            
            logContainer.scrollTop = logContainer.scrollHeight;
            
            renderGamePlayerList();
            updateStats();
        }

        function renderGamePlayerList() {
            const list = document.getElementById("playerListGame");
            list.innerHTML = "";
            
            players.forEach(player => {
                const li = document.createElement("li");
                li.className = `player-item ${!player.alive ? "dead" : ""}`;
                
                let roleDisplay = `<span class="role-badge role-unknown">‚ùì Inconnu</span>`;
                
                // Afficher le r√¥le si r√©v√©l√© (mort ou d√©couvert par voyante)
                if (gameState.revealedRoles[player.name]) {
                    const roleClass = `role-${gameState.revealedRoles[player.name].toLowerCase().replace("-", "").replace(" ", "")}`;
                    const roleIcon = roles.find(r => r.name === gameState.revealedRoles[player.name])?.icon || "‚ùì";
                    roleDisplay = `<span class="role-badge ${roleClass}">${roleIcon} ${gameState.revealedRoles[player.name]}</span>`;
                }
                
                // Afficher tous les r√¥les √† la fin si l'option est activ√©e
                const revealRoles = document.getElementById("revealRolesAtEnd").checked;
                const gameEnded = checkGameEndSilent();
                if (gameEnded && revealRoles) {
                    const roleClass = `role-${player.role.toLowerCase().replace("-", "").replace(" ", "")}`;
                    const roleIcon = roles.find(r => r.name === player.role)?.icon || "‚ùì";
                    roleDisplay = `<span class="role-badge ${roleClass}">${roleIcon} ${player.role}</span>`;
                }
                
                li.innerHTML = `
                    <div class="player-info">
                        ${player.image ? `<img src="${player.image}" class="player-image">` : `<div class="player-image" style="background: #666; display: flex; align-items: center; justify-content: center;">üë§</div>`}
                        <span>${player.name}</span>
                        ${roleDisplay}
                        ${player.inCouple ? "üíï" : ""}
                    </div>
                    <div>
                        ${player.alive ? "‚úÖ Vivant" : "üíÄ Mort"}
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function updateStats() {
            const alive = players.filter(p => p.alive);
            const villageois = alive.filter(p => p.role !== "Loup-Garou").length;
            const loups = alive.filter(p => p.role === "Loup-Garou").length;
            
            document.getElementById("villageoisCount").textContent = villageois;
            document.getElementById("loupsCount").textContent = loups;
            document.getElementById("aliveCount").textContent = alive.length;
        }

        function checkGameEndSilent() {
            const alive = players.filter(p => p.alive);
            const villageois = alive.filter(p => p.role !== "Loup-Garou");
            const loups = alive.filter(p => p.role === "Loup-Garou");
            
            return loups.length === 0 || villageois.length === 0 || alive.length === 0;
        }

        function checkGameEnd() {
            const alive = players.filter(p => p.alive);
            const villageois = alive.filter(p => p.role !== "Loup-Garou");
            const loups = alive.filter(p => p.role === "Loup-Garou");
            
            if (loups.length === 0) {
                endGame("Les Villageois");
            } else if (villageois.length === 0 || alive.length === 0) {
                endGame("Les Loups-Garous");
            }
        }

        function endGame(winner) {
            document.getElementById("gameScreen").classList.add("hide");
            document.getElementById("endScreen").classList.remove("hide");
            
            document.getElementById("winnerTeam").textContent = `${winner} ont gagn√©!`;
        }

        function backToSetup() {
            document.getElementById("setupScreen").classList.remove("hide");
            document.getElementById("gameScreen").classList.add("hide");
            document.getElementById("endScreen").classList.add("hide");
        }

        function newGame() {
            document.getElementById("setupScreen").classList.remove("hide");
            document.getElementById("gameScreen").classList.add("hide");
            document.getElementById("endScreen").classList.add("hide");
        }

        window.onload = init;
    </script>
</body>
</html>